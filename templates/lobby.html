{% extends "base.html" %}

{% block title %}Game Lobby{% endblock %}

{% block extra_head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
{% endblock %}

{% block content %}
    <header>
        <h1>Welcome to <span style="color: var(--primary-color)">UNO</span>, <span id="username">{{ username }}</span>!</h1>
        <a href="/logout" class="btn btn-logout">Logout</a>
    </header>
    
    <div class="game-section">
        <div>
            <h2>Create or Join a Game</h2>
            <button id="create-game" class="btn">Create New Game</button>
        </div>
        
        <div>
            <h2>Available Games</h2>
            <div id="game-list" class="game-list">
                <div class="no-games">
                    <p>No games available. Create one to get started!</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const socket = io();
        const username = document.getElementById('username').textContent;
        
        document.getElementById('create-game').addEventListener('click', () => {
            socket.emit('create_game');
        });
        
        socket.on('game_created', (data) => {
            window.location.href = `/game/${data.game_id}`;
        });
        
        socket.on('games_list', (data) => {
            const gameListElement = document.getElementById('game-list');
            
            if (data.games.length === 0) {
                gameListElement.innerHTML = `
                    <div class="no-games">
                        <p>No games available. Create one to get started!</p>
                    </div>
                `;
                return;
            }
            
            gameListElement.innerHTML = data.games.map(game => `
                <div class="game-card">
                    <h3>Game ${game.game_id.slice(0, 8)}</h3>
                    <p>Players: ${game.player_count}/4</p>
                    <div class="players">
                        ${game.players.map(player => `
                            <span class="player-tag">${player}</span>
                        `).join('')}
                    </div>
                    <button class="btn btn-small join-game" data-game-id="${game.game_id}">Join Game</button>
                </div>
            `).join('');
            
            // Add event listeners to join buttons
            document.querySelectorAll('.join-game').forEach(button => {
                button.addEventListener('click', () => {
                    const gameId = button.getAttribute('data-game-id');
                    socket.emit('join_game', { game_id: gameId });
                });
            });
        });
        
        socket.on('join_success', (data) => {
            window.location.href = `/game/${data.game_id}`;
        });
        
        socket.on('join_error', (data) => {
            alert(data.message);
        });
        
        // Request games list when page loads
        socket.emit('get_games');
    </script>
{% endblock %}